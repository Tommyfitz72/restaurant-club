generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ReservationProvider {
  OPENTABLE
  RESY
  GOOGLE
  DIRECT
}

enum IngestionStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum RestaurantTagType {
  VIBE
  STYLE
  ASPECT
  QUALITY
}

model Restaurant {
  id            String                @id @default(cuid())
  name          String
  cuisineType   String
  city          String
  neighborhood  String
  address       String
  priceRange    Int
  imageUrl      String
  bookingLinks  Json
  ratings       RestaurantRating[]
  reservations  ReservationSlot[]
  tagSignals    RestaurantTagSignal[]
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  @@unique([name, city])
}

model ReservationSlot {
  id             String              @id @default(cuid())
  provider       ReservationProvider
  externalSlotId String
  restaurantId   String
  startsAt       DateTime
  partySize      Int
  bookingUrl     String
  available      Boolean             @default(true)
  scannedAt      DateTime            @default(now())
  restaurant     Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([startsAt])
  @@index([partySize])
  @@index([available])
  @@unique([provider, externalSlotId, partySize])
}

model UserProfile {
  id                 String             @id @default(cuid())
  sessionId          String             @unique
  cuisinePreferences String[]
  preferredTimes     Json?
  defaultPartySize   Int?
  priceMin           Int?
  priceMax           Int?
  ratings            RestaurantRating[]
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model RestaurantRating {
  id           String      @id @default(cuid())
  profileId    String
  restaurantId String
  rating       Int
  profile      UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([profileId, restaurantId])
  @@index([restaurantId])
}

model SourceIngestionRun {
  id              String               @id @default(cuid())
  mode            String
  status          IngestionStatus      @default(RUNNING)
  sourceCount     Int                  @default(0)
  restaurantCount Int                  @default(0)
  tagCount        Int                  @default(0)
  notes           String?
  startedAt       DateTime             @default(now())
  completedAt     DateTime?
  tagSignals      RestaurantTagSignal[]

  @@index([startedAt])
}

model RestaurantTagSignal {
  id             String            @id @default(cuid())
  restaurantId   String
  ingestionRunId String?
  sourceName     String
  sourceUrl      String
  tagType        RestaurantTagType
  tagValue       String
  confidence     Float
  evidence       String?
  observedAt     DateTime          @default(now())
  restaurant     Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  ingestionRun   SourceIngestionRun? @relation(fields: [ingestionRunId], references: [id], onDelete: SetNull)

  @@index([restaurantId])
  @@index([tagType])
  @@index([sourceName])
  @@index([observedAt])
  @@unique([restaurantId, sourceName, tagType, tagValue])
}
